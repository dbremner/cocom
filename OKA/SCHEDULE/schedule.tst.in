#!/bin/sh

#
# Script to test of the scheduler.
#

#
# Usage: schedule.tst
#
# The script outputs self-explanatory messages and returns zero exit code if 
# it is all ok.
#

CC='@CC@ @CFLAGS@ @DEFS@ -I. -I../../AMMUNITION -I@top_srcdir@/AMMUNITION'
result=fail
echo +++++++++++ Testing Scheduler for C ++++++++++++++++++++++++++++++++
echo ++++++++++Now building pipeline hazards recognizer
if ../oka -export @srcdir@/test.oka; then
        echo ++++++++++Now compilation of all scheduler files
        if $CC test.c @srcdir@/schedule.c @srcdir@/schedtst.c @top_srcdir@/AMMUNITION/allocate.c -o ./a.out; then
                echo ++++++++++Now scheduling
                if ./a.out >_test.res; then
                        if cat >_test1.res <<'EOF' && cmp _test.res _test1.res; then
******ORIGINAL
|01234567890123456789| Start  Stop Number Instruction
|I                   |     0     0      1 ADD	#1, #2, #3
|.I                  |     1    19      2 MUL	#5, #3, #4
|I...................|    20    52      3 DIV	#1, #2, #5
|.............I......|    53    85      4 DIV	#6, #2, #3
|             .I     |    54    72      5 MUL	#5, #5, #5
|              I     |    54    56      6 FMUL	#11, #12, #13
|              .I    |    55    57      7 FADD	#13, #13, #14
|               ...I |    58    85      8 FDIV	#11, #12, #13
Summary execution time = 85
critical path length = 38

******NEW
|01234567890123456789| Start  Stop Number Instruction
|I                   |     0    18      2 MUL	#5, #3, #4
|I                   |     0     2      6 FMUL	#11, #12, #13
|.I                  |     1    33      4 DIV	#6, #2, #3
| I                  |     1     3      7 FADD	#13, #13, #14
| .I                 |     2     2      1 ADD	#1, #2, #3
|  ..I               |     4    31      8 FDIV	#11, #12, #13
|..............I.....|    34    66      3 DIV	#1, #2, #5
|              .I    |    35    53      5 MUL	#5, #5, #5
Summary execution time = 66
critical path length = 38
EOF
                                result=ok
                        fi
                fi
        fi
fi

# Final message

if test $result = ok; then
	echo it is all ok
        rm -f a.out test.h test.c _test.res _test1.res
	exit 0
else
	echo '***' test is failed see _test.res _test1.res
	exit 1
fi
